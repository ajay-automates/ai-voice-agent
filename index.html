<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Voice Agent</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{min-height:100vh;background:#faf9f7;font-family:'DM Sans',sans-serif;color:#1a1a2e}
  ::selection{background:#5b5bd6;color:#fff}
  .container{max-width:700px;margin:0 auto;padding:40px 20px}
  .header{text-align:center;margin-bottom:40px}
  .header .eyebrow{font-family:'JetBrains Mono',monospace;font-size:.65rem;letter-spacing:4px;color:#5b5bd6;text-transform:uppercase;margin-bottom:12px}
  .header h1{font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:800;color:#0a0a0b;letter-spacing:-1px;margin-bottom:8px}
  .header .sub{color:#888;font-size:.95rem;line-height:1.5}
  .setup-card{background:#fff;border:1px solid #e8e8ec;border-radius:16px;padding:24px;margin-bottom:24px}
  .setup-card h3{font-family:'JetBrains Mono',monospace;font-size:.7rem;letter-spacing:2px;color:#5b5bd6;text-transform:uppercase;margin-bottom:12px}
  .setup-card textarea{width:100%;border:1px solid #e0e0e6;border-radius:10px;padding:14px;font-family:'DM Sans',sans-serif;font-size:.9rem;resize:vertical;min-height:100px;transition:border-color .2s}
  .setup-card textarea:focus{outline:none;border-color:#5b5bd6}
  .btn-upload{margin-top:12px;padding:10px 24px;background:#5b5bd6;color:#fff;border:none;border-radius:10px;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s}
  .btn-upload:hover{background:#4c4cbf}
  .btn-upload:disabled{background:#ccc;cursor:not-allowed}
  .doc-status{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:#34c759;margin-top:8px}
  .doc-status.empty{color:#ffb340}
  .chat-area{background:#fff;border:1px solid #e8e8ec;border-radius:16px;padding:24px;margin-bottom:24px;min-height:200px;max-height:400px;overflow-y:auto}
  .msg{margin-bottom:16px;animation:fadeIn .3s ease}
  .msg-user{text-align:right}
  .msg-user .bubble{display:inline-block;background:#5b5bd6;color:#fff;padding:10px 16px;border-radius:16px 16px 4px 16px;max-width:80%;font-size:.9rem;line-height:1.5}
  .msg-agent .bubble{display:inline-block;background:#f0f0f5;color:#1a1a2e;padding:10px 16px;border-radius:16px 16px 16px 4px;max-width:80%;font-size:.9rem;line-height:1.5}
  .msg-label{font-family:'JetBrains Mono',monospace;font-size:.6rem;letter-spacing:1px;color:#aaa;margin-bottom:4px;text-transform:uppercase}
  .msg-metrics{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:#bbb;margin-top:4px}
  .mic-area{text-align:center;margin:32px 0}
  .mic-btn{width:88px;height:88px;border-radius:50%;border:3px solid #5b5bd6;background:#fff;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;-webkit-user-select:none;user-select:none}
  .mic-btn:hover{box-shadow:0 0 30px rgba(91,91,214,.2)}
  .mic-btn.recording{background:#5b5bd6;border-color:#5b5bd6;box-shadow:0 0 0 8px rgba(91,91,214,.15),0 0 40px rgba(91,91,214,.3);animation:recordPulse 1.5s ease infinite}
  .mic-btn.processing{background:#f0f0f5;border-color:#ccc;cursor:wait}
  .mic-btn svg{transition:all .2s}
  .mic-btn.recording svg{stroke:#fff}
  .mic-status{font-family:'JetBrains Mono',monospace;font-size:.7rem;letter-spacing:1.5px;color:#888;margin-top:12px;text-transform:uppercase}
  .mic-status.recording{color:#5b5bd6;font-weight:600}
  .mic-status.processing{color:#ffb340}
  @keyframes recordPulse{0%,100%{box-shadow:0 0 0 8px rgba(91,91,214,.15),0 0 40px rgba(91,91,214,.3)}50%{box-shadow:0 0 0 16px rgba(91,91,214,.08),0 0 60px rgba(91,91,214,.2)}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .text-input-area{display:flex;gap:8px;margin-top:16px}
  .text-input-area input{flex:1;padding:12px 16px;border:1px solid #e0e0e6;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.9rem}
  .text-input-area input:focus{outline:none;border-color:#5b5bd6}
  .text-input-area button{padding:12px 20px;background:#5b5bd6;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-size:.85rem}
  .footer{text-align:center;padding:20px 0;font-family:'JetBrains Mono',monospace;font-size:.6rem;color:#ccc;letter-spacing:1px}
  .footer a{color:#5b5bd6;text-decoration:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="eyebrow">REAL-TIME AI VOICE AGENT</div>
    <h1>Voice Agent</h1>
    <p class="sub">Upload your business docs. Then just talk. The AI answers instantly using your documents.</p>
  </div>

  <div class="setup-card">
    <h3>KNOWLEDGE BASE</h3>
    <textarea id="docInput" placeholder="Paste your business FAQ, policies, product info here..."></textarea>
    <button class="btn-upload" id="uploadBtn" onclick="uploadDocs()">LOAD DOCUMENTS</button>
    <div class="doc-status empty" id="docStatus">NO DOCUMENTS LOADED</div>
  </div>

  <div class="chat-area" id="chatArea"></div>

  <div class="mic-area">
    <button class="mic-btn" id="micBtn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#5b5bd6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        <line x1="12" y1="19" x2="12" y2="23"/>
        <line x1="8" y1="23" x2="16" y2="23"/>
      </svg>
    </button>
    <div class="mic-status" id="micStatus">HOLD TO SPEAK</div>
  </div>

  <div class="text-input-area">
    <input type="text" id="textInput" placeholder="Or type your question here..." onkeydown="if(event.key==='Enter')sendText()">
    <button onclick="sendText()">SEND</button>
  </div>

  <div class="footer">
    BUILT BY <a href="https://github.com/ajay-automates">AJAY KUMAR REDDY</a> | WHISPER + GPT-4o + TTS
  </div>
</div>

<script>
let mediaRecorder=null,audioChunks=[],isRecording=false;
const micBtn=document.getElementById('micBtn'),micStatus=document.getElementById('micStatus'),chatArea=document.getElementById('chatArea');

async function uploadDocs(){
  const text=document.getElementById('docInput').value.trim();
  if(!text)return;
  const btn=document.getElementById('uploadBtn');
  btn.disabled=true;btn.textContent='LOADING...';
  try{
    const form=new FormData();form.append('text',text);
    const res=await fetch('/api/upload-text',{method:'POST',body:form});
    const data=await res.json();
    document.getElementById('docStatus').textContent='DOCUMENTS LOADED ('+data.length+' CHARS)';
    document.getElementById('docStatus').className='doc-status';
  }catch(e){document.getElementById('docStatus').textContent='ERROR: '+e.message}
  btn.disabled=false;btn.textContent='LOAD DOCUMENTS';
}

async function startRecording(){
  if(isRecording)return;
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data)};
    mediaRecorder.start();
    isRecording=true;
    micBtn.classList.add('recording');
    micStatus.textContent='LISTENING...';
    micStatus.className='mic-status recording';
  }catch(e){micStatus.textContent='MIC ACCESS DENIED'}
}

async function stopRecording(){
  if(!isRecording||!mediaRecorder)return;
  isRecording=false;
  micBtn.classList.remove('recording');
  micBtn.classList.add('processing');
  micStatus.textContent='PROCESSING...';
  micStatus.className='mic-status processing';
  mediaRecorder.stop();
  mediaRecorder.onstop=async()=>{
    const audioBlob=new Blob(audioChunks,{type:'audio/webm'});
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    await sendVoice(audioBlob);
    micBtn.classList.remove('processing');
    micStatus.textContent='HOLD TO SPEAK';
    micStatus.className='mic-status';
  };
}

async function sendVoice(audioBlob){
  const form=new FormData();
  form.append('audio',audioBlob,'recording.webm');
  try{
    const res=await fetch('/api/voice',{method:'POST',body:form});
    if(!res.ok){const err=await res.json();addMessage('agent','Error: '+(err.detail||'Something went wrong'));return}
    const userText=res.headers.get('X-User-Text')||'';
    const agentText=res.headers.get('X-Agent-Text')||'';
    const sttTime=res.headers.get('X-STT-Time')||'?';
    const llmTime=res.headers.get('X-LLM-Time')||'?';
    const ttsTime=res.headers.get('X-TTS-Time')||'?';
    const totalTime=res.headers.get('X-Total-Time')||'?';
    if(userText)addMessage('user',userText);
    const metrics='STT: '+sttTime+'s | LLM: '+llmTime+'s | TTS: '+ttsTime+'s | Total: '+totalTime+'s';
    addMessage('agent',agentText,metrics);
    const audioData=await res.blob();
    const audioUrl=URL.createObjectURL(audioData);
    const audio=new Audio(audioUrl);
    audio.play();
  }catch(e){addMessage('agent','Connection error: '+e.message)}
}

async function sendText(){
  const input=document.getElementById('textInput');
  const text=input.value.trim();
  if(!text)return;
  input.value='';
  addMessage('user',text);
  try{
    const form=new FormData();form.append('text',text);
    const res=await fetch('/api/text',{method:'POST',body:form});
    const data=await res.json();
    addMessage('agent',data.answer);
  }catch(e){addMessage('agent','Error: '+e.message)}
}

function addMessage(role,text,metrics){
  const div=document.createElement('div');
  div.className='msg msg-'+role;
  let html='<div class="msg-label">'+(role==='user'?'YOU':'AGENT')+'</div>';
  html+='<div class="bubble">'+escapeHtml(text)+'</div>';
  if(metrics)html+='<div class="msg-metrics">'+metrics+'</div>';
  div.innerHTML=html;
  chatArea.appendChild(div);
  chatArea.scrollTop=chatArea.scrollHeight;
}

function escapeHtml(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
</script>
</body>
</html>
